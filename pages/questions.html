<!DOCTYPE html>
<html lang="bg">
  <head>
    <title>Въпроси</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="./../css/common.css" rel="stylesheet" type="text/css">
    <link href="./../css/home.css" rel="stylesheet" type="text/css">
    <link href="./../css/questions.css" rel="stylesheet" type="text/css">
    <script src="https://kit.fontawesome.com/5c9473fc67.js" crossorigin="anonymous"></script>
    <script src="../js/logout.js" defer></script>
    <script src="../js/toggleNav.js"></script>
    <script src="../js/questionTable.js"></script>
    <script>
    function getToken() {
      return document.cookie
        .split("; ")
        .find((row) => row.startsWith("token="))
        .split("=")[1];
    }
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
      fetchAndPopulateTests(getToken());
      fetchAndPopulateQuestionTypes();
      populateIsMultipleChoiceSelect();
      applyFilters(getToken());
    });
    </script>
    <script>
    const url = `../api/tests`;
    function createTest(){
      fetch(url, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${getToken()}`
        },
        body: JSON.stringify({author: document.getElementById("authorName").value.trim() || null, topic: document.getElementById("topicName").value.trim() || "Неименуван тест"})
      })
        .then((response) => response.json())
        .then(() => {
          applyTestFilters();      
          fetchAndPopulateTests(getToken());
        })
        .catch((error) =>console.error("Error creating test:", error));
    }
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
      applyTestFilters(getToken());
    });
    </script>
    <script>
    function applyTestFilters() {
      const sidebarTestSearch = document.querySelector("#sidebarTestSearch");
      const testsSection = document.querySelector("#tests");
      testsSection.innerHTML = "";

      const searchFilter = sidebarTestSearch.value.trim();
      const queryParams = new URLSearchParams();
      if (searchFilter !== "") queryParams.set("topic", searchFilter);
      queryParams.set("size", -1);

      fetch("../api/tests?"+queryParams.toString(), {
        headers: {
          Authorization: `Bearer ${getToken()}`
        },
      })
        .then((response) => response.json())
        .then((tests) => {

          if (tests.length === 0) {
            testsSection.innerHTML += "<p>Нямате създадени тестове.<p>";
          } else {
            tests.forEach((test) => {
              // Fetch questions for each test
              fetch(`../api/questions?testId=${test.id}`, {
                headers: {
                  Authorization: `Bearer ${getToken()}`,
                },
              })
                .then((response) => response.json())
                .then((questions) => {
                  const testSection = document.createElement("section");
                  testSection.classList.add("item");
                  testSection.setAttribute('data-id', test.id);

                  const testLink = document.createElement("a");
                  testLink.href = `testPreview.php?testId=${test.id}`;

                  const testTitle = document.createElement("h3");
                  testTitle.textContent = test.topic;

                  const testAuthor = document.createElement("p");
                  testAuthor.textContent = `Автор: ${test.author}`;

                  const testQuestions = document.createElement("p");
                  testQuestions.textContent = `Въпроси: ${questions.length}`;

                  testLink.appendChild(testTitle);
                  testSection.appendChild(testLink);
                  testSection.appendChild(testAuthor);
                  testSection.appendChild(testQuestions);
                  testsSection.appendChild(testSection);
                  testSection.addEventListener("click", function(){
                    document.getElementById("testSelect").value=testSection.dataset.id;
                    applyFilters(getToken());
                  })
                })
                .catch((error) =>
                  console.error("Error fetching questions:", error)
                );
            });
          }
        })
        .catch((error) => console.error("Error fetching tests:", error));
    }
    </script>
    <script>
      function readCSV() {
        var fileInput = document.getElementById('csvFile');
        var file = fileInput.files[0];
        var formData = new FormData();
        formData.append('csvFile', file);
        console.log("I'm here");
        var authToken = getToken();
        fetch('./../libs/readCSV.php', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + authToken
          },
          body: formData
        })
                .then(response => response.text())
                .then(result => {
                  location.reload();
                })
                .catch(error => {
                  console.error("Error reading from csv file:", error);
                });
      }
    </script>
  </head>
  <body>
    <header>
      <nav>
        <span class="fa fa-bars" id="menu" onclick="toggleNav()"></span>
        <h1><a href="./index.html">KnowledgeTest</a></h1>
        <ul>
          <a href="./home.html"><li><span class="fa fa-user"></span>Потребител</li></a>
          <a href="./questions.html"><li><span class="fa fa-question"></span>Въпроси</li></a>
          <a onclick="logout()"><li><span class="fa fa-power-off"></span>Изход</li></a>
        </ul>
      </nav>
    </header>
    <aside>
      <section class="activity">
        <h2>Тестове</h2>
        <button type="button" onclick="document.getElementById('uploadCSVDialog').showModal()"><span class="fa fa-upload"></span>Качване</button>
        <dialog id="uploadCSVDialog">
          <form id="uploadForm">
            <input type="file" name="topic" id="csvFile" accept=".csv">
            <button type="submit" formmethod="dialog">Отказ</button>
            <button type="submit" id="importButton" onclick="readCSV()" formmethod="dialog">Импортиране</button>
          </form>
        </dialog>
        <button type="button" onclick="document.getElementById('createTestDialog').showModal()"><span class="fa fa-plus"></span>Нов тест</button>
        <dialog id="createTestDialog">
          <form>
            <input type="text" name="topic" placeholder="Въведете тема" id="topicName">
            <input type="text" name="author" placeholder="Въведете автор" id="authorName">
            <button type="submit" formmethod="dialog">Отказ</button>
            <button type="submit" onclick="createTest()" formmethod="dialog">Създаване</button>
          </form>
        </dialog>
        <input type="search" name="testSearch" id="sidebarTestSearch"/>
        <button type="button" onclick="applyTestFilters()"><span class="fa fa-search"></span></button>
        <div id="tests">

        </div>
      </section>
    </aside>
    <main>
      <section class="activity" id="questions">
        <div>
          <span>
            <span>Страница </span>
            <input type="number" name="page" value="1" min="1" id="pageField" onchange="applyFilters(getToken())">
            <span>. </span>
          </span>
          <span>
            <span>Покажи </span>
            <select id="sizeSelect" onchange="applyFilters(getToken())">
              <option value="1">1</option>
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="-1">Всички</option>
            </select>
          </span>
        </div>
        <table class="questions-table">
          <thead>
            <tr>
              <th>
                <input type="checkbox" onchange="selectAll()">
              </th>
              <th data-sort="label">Въпрос<span class="fa fa-sort sort-icon"></span></th>
              <th data-sort="testId">Тест<span class="fa fa-sort sort-icon"></span></th>
              <th data-sort="aim">Цел<span class="fa fa-sort sort-icon"></span></th>
              <th data-sort="questionType">Тип<span class="fa fa-sort sort-icon"></span></th>
              <th data-sort="isMultipleChoice">С множествен отговор<span class="fa fa-sort sort-icon"></span></th>
            </tr>
            <tr>
              <th>
                <button onclick="applyFilters(getToken())"><span class="fa fa-search"></span></button>
              </th>
              <th>
                <input type="search" id="labelSearchField"> 
              </th>
              <th>
                <select id="testSelect" onchange="applyFilters(getToken())"></select>
              </th>
              <th>
                <input type="search" id="aimSearchField">
              </th>
              <th>
                <select id="questionTypeSelect" onchange="applyFilters(getToken())"></select>
              </th>
              <th>
              <select id="isMultipleChoiceSelect" onchange="applyFilters(getToken())"></select>
            </th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </section>
    </main>
    <footer>
      <p>KnowledgeTest 2023&copy;</p>
      <p>
        <span>Даниел Халачев, </span>
        <span>Стефан Велев</span>
      </p>
    </footer>
  </body>
</html>

