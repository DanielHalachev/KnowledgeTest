<!DOCTYPE html>
<html lang="bg">
  <head>
    <title>Добре дошли</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="./../css/common.css" rel="stylesheet" type="text/css">
    <link href="./../css/home.css" rel="stylesheet" type="text/css">
    <script src="https://kit.fontawesome.com/5c9473fc67.js" crossorigin="anonymous"></script>
    <script src="../js/logout.js" defer></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Retrieve token from the "token" cookie
      const token = document.cookie
          .split("; ")
          .find((row) => row.startsWith("token="))
          .split("=")[1];
      // Fetch user data from the API using the bearer token
      fetch("../api/users", {
        headers: {
          Authorization: `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        // Extract user data
        const {email, firstName, lastName, profilePicture } = data[0];
        console.log(email);

        // Set user details in the HTML
        document.getElementById("firstName").textContent = firstName;
        document.getElementById("lastName").textContent = lastName;
        document.getElementById("email").textContent = email;

        // Set the profile picture source
        const imgSrc = profilePicture ? `../img/usr/${profilePicture}` : "../img/usr/profile.png";
        document.getElementById("profilePicture").src = imgSrc;
      })
      .catch(error => {
        console.error("Error fetching user data:", error);
      });
    
      // Fetch tests
      fetch("../api/tests", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      })
        .then((response) => response.json())
        .then((tests) => {
          const testsSection = document.querySelector("#latest-tests");

          if (tests.length === 0) {
            testsSection.innerHTML += "<p>Нямате създадени тестове.<p>";
          } else {
            tests.forEach((test) => {
              // Fetch questions for each test
              fetch(`../api/questions?testId=${test.id}`, {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              })
                .then((response) => response.json())
                .then((questions) => {
                  const testSection = document.createElement("section");
                  testSection.classList.add("test");

                  const testLink = document.createElement("a");
                  testLink.href = `testPreview.php?testId=${test.id}`;

                  const testTitle = document.createElement("h3");
                  testTitle.textContent = test.topic;

                  const testAuthor = document.createElement("p");
                  testAuthor.textContent = `Автор: ${test.author}`;

                  const testQuestions = document.createElement("p");
                  testQuestions.textContent = `Брой въпроси: ${questions.length}`;

                  testLink.appendChild(testTitle);
                  testSection.appendChild(testLink);
                  testSection.appendChild(testAuthor);
                  testSection.appendChild(testQuestions);
                  testsSection.appendChild(testSection);
                })
                .catch((error) =>
                  console.error("Error fetching questions:", error)
                );
            });
          }
        })
        .catch((error) => console.error("Error fetching tests:", error));
      // Fetch questions
      fetch("../api/questions", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      })
        .then((response) => response.json())
        .then((questions) => {
          const questionsSection = document.querySelector("#latest-questions");

          if (questions.length === 0) {
            questionsSection.innerHTML += "<p>Нямате създадени въпроси.</p>";
          } else {
            questions.forEach((question) => {
              // Fetch test information for each question
              fetch(`../api/tests/${question.testId}`, {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              })
                .then((response) => response.json())
                .then((test) => {
                  const questionSection = document.createElement("section");
                  questionSection.classList.add("question");

                  const questionLink = document.createElement("a");
                  questionLink.href = `questions.html?questionId=${question.id}`;

                  const questionLabel = document.createElement("h3");
                  questionLabel.textContent = question.label;

                  const questionTest = document.createElement("p");
                  questionTest.textContent = `Test: ${test.topic}`;

                  const questionAim = document.createElement("p");
                  questionAim.textContent = `Aim: ${question.aim}`;

                  const questionIsMultipleChoice = document.createElement("p");
                  questionIsMultipleChoice.textContent = `Multiple Choice: ${
                    question.isMultipleChoice ? "Yes" : "No"
                  }`;

                  questionLink.appendChild(questionLabel);
                  questionSection.appendChild(questionLink);
                  questionSection.appendChild(questionTest);
                  questionSection.appendChild(questionAim);
                  questionSection.appendChild(questionIsMultipleChoice);
                  questionsSection.appendChild(questionSection);
                })
                .catch((error) =>
                  console.error("Error fetching test information:", error)
                );
            });
          }
        })
        .catch((error) => console.error("Error fetching questions:", error));
    });
    </script>
  </head>
  <body>
    <header>
      <nav>
        <h1><a href="./home.html">KnowledgeTest</a></h1>
        <ul>
          <a href="./tests.html"><li><span class="fa fa-list-ol"></span>Тестове</li></a>
          <a href="./questions.html"><li><span class="fa fa-question"></span>Въпроси</li></a>
          <a href="./index.php"><li><span class="fa fa-power-off"></span>Изход</li></a>
        </ul>
      </nav>
    </header>
    <aside>
      <section class="activity">
        <h2>Профил</h2>
        <img id="profilePicture" src="./../img/usr/profile.png" alt="profile picture"/>
        <p id="firstName">FirstName</p>
        <p id="lastName">LastName</p>
        <p id="email">Email</p>
        <button type="button" onclick="logout()"><span class="fa fa-power-off"></span>Изход</button>
        <button type="button" onclick="window.location = './changePassword.php'"><span class="fa fa-key"></span>Смяна на паролата</button>
        <button type="button"><span class="fa fa-user-slash"></span>Изтриване на профила</button>
      </section>
    </aside>
    <main>
      <section class="activity" id="latest-tests">
        <h2>Последни тестове</h2>
      </section>
      <section class="activity" id="latest-questions">
        <h2>Последни въпроси</h2>
      </section>
    </main>
    <footer>
      <p>KnowledgeTest 2023&copy;</p>
      <p>
        <span>Даниел Халачев, </span>
        <span>Стефан Велев</span>
      </p>
    </footer>
  </body>
</html>

